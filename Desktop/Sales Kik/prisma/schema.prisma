// Core SalesKik Schema for Supabase - Working Models Only
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Company Model
model Company {
  id                  String   @id @default(uuid())
  name                String
  email               String
  phone               String?
  address             Json?
  logoUrl             String?  @map("logo_url")
  subscriptionStatus  String   @default("TRIAL") @map("subscription_status")
  trialEndsAt         DateTime? @map("trial_ends_at")
  created_at          DateTime @default(now()) @map("created_at")
  updated_at          DateTime @updatedAt @map("updated_at")
  
  // Working Relations
  users       User[]
  customers   Customer[]
  quotes      Quote[]
  orders      Order[]
  invoices    Invoice[]
  locations   Location[]
  suppliers   Supplier[]
  products    Product[]
  userGroups  UserGroup[]
  categories  Category[]
  
  @@map("companies")
}

// User Management
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  passwordHash String   @map("password_hash")
  role         String   @default("USER")
  company_id   String   @map("company_id")
  company      Company  @relation(fields: [company_id], references: [id])
  isActive     Boolean  @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")
  
  // Relations
  authSessions AuthSession[]
  groupMemberships UserGroupMembership[]
  
  @@map("users")
}

// Product Catalog - Core Product Information
model Product {
  id                    String               @id @default(uuid())
  code                  String               @unique
  name                  String
  description           String?
  category_id           String?              @map("category_id")
  category              Category?            @relation(fields: [category_id], references: [id])
  main_category_id      String?              @map("main_category_id")
  sub_category_id       String?              @map("sub_category_id") 
  sub_sub_category_id   String?              @map("sub_sub_category_id")
  sub_sub_sub_category_id String?            @map("sub_sub_sub_category_id")
  supplier_id           String?              @map("supplier_id")
  supplier              Supplier?            @relation(fields: [supplier_id], references: [id])
  weight                Float?
  dimensions            Json?                // Store length, width, height as JSON
  company_id            String               @map("company_id")
  company               Company              @relation(fields: [company_id], references: [id])
  is_active             Boolean              @default(true) @map("is_active")
  created_at            DateTime             @default(now()) @map("created_at")
  updated_at            DateTime             @updatedAt @map("updated_at")
  
  // Relations
  pricing       ProductPricing[]
  inventory     ProductInventory[]
  
  @@map("products")
}

// Product Pricing - Separate Table for Multiple Price Tiers
model ProductPricing {
  id         String  @id @default(uuid())
  product_id String  @map("product_id")
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  
  // Pricing Tiers
  cost_price Float   @default(0) @map("cost_price")
  tier_1     Float   @default(0) @map("tier_1")
  tier_2     Float   @default(0) @map("tier_2") 
  tier_3     Float   @default(0) @map("tier_3")
  retail     Float   @default(0)
  
  // Customer-specific pricing
  customer_id String? @map("customer_id")
  customer    Customer? @relation(fields: [customer_id], references: [id])
  
  // Pricing metadata
  effective_date DateTime @default(now()) @map("effective_date")
  expires_date   DateTime? @map("expires_date")
  created_at     DateTime @default(now()) @map("created_at")
  updated_at     DateTime @updatedAt @map("updated_at")
  
  @@unique([product_id, customer_id]) // One pricing record per product per customer
  @@map("product_pricing")
}

// Product Inventory - Separate Table for Stock Management
model ProductInventory {
  id              String  @id @default(uuid())
  product_id      String  @map("product_id")
  product         Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  location_id     String  @map("location_id")
  location        Location @relation(fields: [location_id], references: [id])
  
  // Stock levels
  current_stock   Int     @default(0) @map("current_stock")
  reserved_stock  Int     @default(0) @map("reserved_stock")
  available_stock Int     @default(0) @map("available_stock")
  reorder_point   Int     @default(10) @map("reorder_point")
  max_stock       Int     @default(100) @map("max_stock")
  
  // Stock metadata
  last_counted    DateTime? @map("last_counted")
  last_movement   DateTime? @map("last_movement")
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")
  
  @@unique([product_id, location_id]) // One inventory record per product per location
  @@map("product_inventory")
}

// Customer Management
model Customer {
  id               String   @id @default(uuid())
  
  // Customer Details
  name             String   // Customer Name *
  accounting_id    String?  @map("accounting_id") // Accounting ID
  sales_rep_id     String?  @map("sales_rep_id")  // Sales Representative ID
  sales_rep_name   String?  @map("sales_rep_name") // Sales Rep Name
  abn_number       String?  @map("abn_number")     // ABN Number
  phone            String?  // Phone Number
  email            String?  // Email
  
  // Primary Contact
  primary_contact_first_name String? @map("primary_contact_first_name")
  primary_contact_last_name  String? @map("primary_contact_last_name") // Last Name *
  primary_contact_email      String? @map("primary_contact_email")     // Email
  primary_contact_landline   String? @map("primary_contact_landline")  // Landline
  primary_contact_fax        String? @map("primary_contact_fax")       // Fax  
  primary_contact_mobile     String? @map("primary_contact_mobile")    // Mobile
  
  // Location Details
  location_type    String?  @default("Main") @map("location_type") // Main, Branch, etc.
  
  // Address Types (separate fields for clarity)
  mailing_address  Json?    @map("mailing_address")  // Mailing address
  billing_address  Json?    @map("billing_address")  // Billing address  
  delivery_address Json?    @map("delivery_address") // Delivery address
  
  // Legacy address field (for backward compatibility)
  address          Json?    // Location details as JSON
  
  // Account Details
  invoice_type     String?  @default("Account") @map("invoice_type") // Account, Cash, etc.
  accounting_terms String?  @map("accounting_terms") // Accounting Terms
  payment_terms    String?  @map("payment_terms")    // Payment Terms
  payment_due_days Int?     @default(30) @map("payment_due_days") // Due X days after invoice
  credit_limit     Float?   @map("credit_limit")     // Credit Limit
  available_limit  Float?   @map("available_limit")  // Available Limit
  
  // Status and Notes
  status           String   @default("active") @map("status") // Status (active, inactive, prospect)
  notes            String?  // Notes
  
  company_id       String   @map("company_id")
  company          Company  @relation(fields: [company_id], references: [id])
  created_at       DateTime @default(now()) @map("created_at")
  updated_at       DateTime @updatedAt @map("updated_at")
  
  // Relationships
  quotes           Quote[]
  orders           Order[]
  invoices         Invoice[]
  pricing          ProductPricing[]
  additional_contacts CustomerContact[]
  price_lists      CustomerPriceList[]
  
  @@map("customers")
}

// Additional Customer Contacts
model CustomerContact {
  id           String   @id @default(uuid())
  customer_id  String   @map("customer_id")
  customer     Customer @relation(fields: [customer_id], references: [id])
  
  first_name   String   @map("first_name") // First Name *
  last_name    String   @map("last_name")  // Last Name *  
  email        String?  // Email
  landline     String?  // Landline
  fax          String?  // Fax
  mobile       String?  // Mobile
  
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")
  
  @@map("customer_contacts")
}

// Customer Price Lists (T1, T2, T3, T4+ with Category Integration)
model CustomerPriceList {
  id          String   @id @default(uuid())
  customer_id String   @map("customer_id")
  customer    Customer @relation(fields: [customer_id], references: [id])
  
  // Category Integration for Price Lists
  category_id String?  @map("category_id") // Link to categories
  category    Category? @relation(fields: [category_id], references: [id])
  
  tier_name   String   @map("tier_name") // T1, T2, T3, T4, etc.
  discount    Float?   // Discount percentage
  markup      Float?   // Markup percentage
  is_active   Boolean  @default(true) @map("is_active")
  
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  
  @@unique([customer_id, category_id, tier_name]) // Unique per customer+category+tier
  @@map("customer_price_lists")
}

// Quote System
model Quote {
  id           String   @id @default(uuid())
  quote_number String   @map("quote_number")
  customer_id  String   @map("customer_id")
  customer     Customer @relation(fields: [customer_id], references: [id])
  company_id   String   @map("company_id")
  company      Company  @relation(fields: [company_id], references: [id])
  status       String   @default("DRAFT")
  total        Float    @default(0)
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")
  
  orders       Order[]
  
  @@map("quotes")
}

// Order System
model Order {
  id           String   @id @default(uuid())
  order_number String   @map("order_number")
  customer_id  String   @map("customer_id")
  customer     Customer @relation(fields: [customer_id], references: [id])
  company_id   String   @map("company_id")
  company      Company  @relation(fields: [company_id], references: [id])
  quote_id     String?  @map("quote_id")
  quote        Quote?   @relation(fields: [quote_id], references: [id])
  status       String   @default("PENDING")
  total        Float    @default(0)
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")
  
  invoices     Invoice[]
  
  @@map("orders")
}

// Invoice System
model Invoice {
  id            String   @id @default(uuid())
  invoice_number String @map("invoice_number")
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  orderId       String?
  order         Order?   @relation(fields: [orderId], references: [id])
  status        String   @default("DRAFT")
  total         Float    @default(0)
  due_date      DateTime? @map("due_date")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("invoices")
}

// Location Management
model Location {
  id          String   @id @default(uuid())
  name        String
  address     Json?
  company_id  String   @map("company_id")
  company     Company  @relation(fields: [company_id], references: [id])
  is_active   Boolean  @default(true) @map("is_active")
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  
  inventory   ProductInventory[]
  
  @@map("locations")
}

// Supplier Management
model Supplier {
  id          String   @id @default(uuid())
  name        String
  email       String?
  phone       String?
  address     Json?
  company_id  String   @map("company_id")
  company     Company  @relation(fields: [company_id], references: [id])
  is_active   Boolean  @default(true) @map("is_active")
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  
  products    Product[]
  
  @@map("suppliers")
}

// Authentication Session Management
model AuthSession {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String    @unique
  refreshToken String    @unique @map("refresh_token")
  expiresAt    DateTime  @map("expires_at")
  deviceInfo   Json?     @map("device_info")
  ipAddress    String?   @map("ip_address")
  lastActivity DateTime? @map("last_activity")
  created_at   DateTime  @default(now()) @map("created_at")
  updated_at   DateTime  @updatedAt @map("updated_at")
  
  @@map("auth_sessions")
}

// User Group Management
model UserGroup {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name        String
  description String?
  permissions Json     @default("{}")
  isActive    Boolean  @default(true) @map("is_active")
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  
  // Relations
  memberships UserGroupMembership[]
  
  @@unique([companyId, name])
  @@map("user_groups")
}

model UserGroupMembership {
  id       String    @id @default(uuid())
  userId   String    @map("user_id")
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId  String    @map("group_id")
  group    UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  joinedAt DateTime  @default(now()) @map("joined_at")
  
  @@unique([userId, groupId])
  @@map("user_group_memberships")
}

// Clean Category Structure - 5 Levels: Color, Main, Sub, Sub Sub, Sub Sub Sub
model Category {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String   @default("#3B82F6")
  sort_order  Int      @default(0) @map("sort_order")
  is_active   Boolean  @default(true) @map("is_active")
  company_id  String   @map("company_id")
  company     Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  
  // Relations
  main_categories     MainCategory[]
  products            Product[]
  customer_pricelists CustomerPriceList[]
  subcategories       Subcategory[] @relation("CategorySubcategories")
  
  @@map("categories")
}

// Level 1: Main Categories
model MainCategory {
  id          String   @id @default(uuid())
  name        String
  description String?
  sort_order  Int      @default(0) @map("sort_order")
  is_active   Boolean  @default(true) @map("is_active")
  category_id String   @map("category_id")
  category    Category @relation(fields: [category_id], references: [id], onDelete: Cascade)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  
  // Relations
  sub_categories SubCategory[]
  
  @@map("main_categories")
}

// Level 2: Sub Categories
model SubCategory {
  id               String       @id @default(uuid())
  name             String
  description      String?
  sort_order       Int          @default(0) @map("sort_order")
  is_active        Boolean      @default(true) @map("is_active")
  main_category_id String       @map("main_category_id")
  main_category    MainCategory @relation(fields: [main_category_id], references: [id], onDelete: Cascade)
  created_at       DateTime     @default(now()) @map("created_at")
  updated_at       DateTime     @updatedAt @map("updated_at")
  
  // Relations
  sub_sub_categories SubSubCategory[]
  
  @@map("sub_categories")
}

// Level 3: Sub Sub Categories
model SubSubCategory {
  id              String      @id @default(uuid())
  name            String
  description     String?
  sort_order      Int         @default(0) @map("sort_order")
  is_active       Boolean     @default(true) @map("is_active")
  sub_category_id String      @map("sub_category_id")
  sub_category    SubCategory @relation(fields: [sub_category_id], references: [id], onDelete: Cascade)
  created_at      DateTime    @default(now()) @map("created_at")
  updated_at      DateTime    @updatedAt @map("updated_at")
  
  // Relations
  sub_sub_sub_categories SubSubSubCategory[]
  
  @@map("sub_sub_categories")
}

// Level 4: Sub Sub Sub Categories
model SubSubSubCategory {
  id                 String         @id @default(uuid())
  name               String
  description        String?
  sort_order         Int            @default(0) @map("sort_order")
  is_active          Boolean        @default(true) @map("is_active")
  sub_sub_category_id String        @map("sub_sub_category_id")
  sub_sub_category   SubSubCategory @relation(fields: [sub_sub_category_id], references: [id], onDelete: Cascade)
  created_at         DateTime       @default(now()) @map("created_at")
  updated_at         DateTime       @updatedAt @map("updated_at")
  
  @@map("sub_sub_sub_categories")
}

// Simplified Frontend-Compatible Subcategory Model
model Subcategory {
  id              String     @id @default(uuid())
  name            String
  description     String?
  color           String     @default("#3B82F6")
  category_id     String     @map("category_id")
  category        Category   @relation("CategorySubcategories", fields: [category_id], references: [id], onDelete: Cascade)
  parent_id       String?    @map("parent_id")
  parent          Subcategory? @relation("SubcategoryHierarchy", fields: [parent_id], references: [id])
  children        Subcategory[] @relation("SubcategoryHierarchy")
  level           Int        @default(0)
  sort_order      Int        @default(0) @map("sort_order")
  is_visible      Boolean    @default(true) @map("is_visible")
  options         Json?      @default("{}")
  linked_products Json?      @default("[]") @map("linked_products")
  created_at      DateTime   @default(now()) @map("created_at")
  updated_at      DateTime   @updatedAt @map("updated_at")
  
  @@map("subcategories")
}